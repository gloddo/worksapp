<!DOCTYPE html>
<html lang="en" dir="ltr">
	<head>
		<meta charset="utf-8">
		<title>WorksApp - First Login</title>
		<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
		<link rel="stylesheet" href="jquery/jquery-ui.css">
	    <script src="jquery/external/jquery/jquery.js"></script>
	    <script src="jquery/jquery-ui.js"></script>
	    <script src="https://www.gstatic.com/firebasejs/5.8.5/firebase.js"></script>
	    <link rel="stylesheet" href="style.css">
		<script src="https://cdnjs.cloudflare.com/ajax/libs/js-sha1/0.6.0/sha1.js"></script>
	    <script type="text/javascript" src="script/script.js"></script>

		<style media="screen">
			.form {
				display: flex;
				width: 375px;
				padding: 30px;
				justify-content: center;
			}
			.form .login-form {
				position: fixed;
				bottom: 80px;
				padding: 0 10px;
				margin: 0;
			}
			.form input {
				margin: 5px 0;
				width: 280px;
			}
			.form h4 {
				margin: 10px 0 5px;
			}
			.form button {
				width: 280px;
				margin-top: 15px;
			}
			.second, .third {
				display: none;
			}
			.welcome-logo img{
				width: 300px
			}
			.third img {
				height: 150px;
				margin: 15px;
				border-radius: 75px;
				align-self: center;
			}

			@-webkit-keyframes showTooltip {
			  from {opacity: 0;}
			    to {opacity: 1;}
			}
			@-moz-keyframes showTooltip {
			  from {opacity: 0;}
			    to {opacity: 1;}
			}
			@keyframes showTooltip {
			  from {opacity: 0;}
			    to {opacity: 1;}
			}

			.message-error:after {
			  content: attr(data-tooltip);
			  position: absolute;
			  top: -25px;
			  left: 5%;
			  display: none;
			  padding: 1em 2em;
			  color: white;
			  width: 150px;
			  padding: 5px 0;
			  border-radius: 6px;
			}

			.message-error:hover:after {
			  display: block;
			  -webkit-animation: showTooltip 0.35s ease-in-out;
			  -moz-animation: showTooltip 0.35s ease-in-out;
			  animation: showTooltip 0.35s ease-in-out;
			}

			.message-error:after {
				color: black;
				font-size: 0.7em;
			  background-color: #fff;
			  padding: 5px;
			  border-radius: 6px;
			  border: 2px solid #ccc
			}

			p.error{
				color: red;
				font-size: 1em;
			}
		</style>
	</head>
	<body>
		<section class="welcome-logo">
			<h2>Welcome to</h2>
			<img src="res/logo-blk-b.png" alt="WorksApp">
		</section>

		<section class="form">
			<form class="login-form first">
				<p class="login-label">
		          Set up your new password:
		        </p>
				<div class="message-error" data-tooltip="Password must be at least 8 characters and must contain at least 1 number">
					<input type="password" class="login-input" placeholder="New password">
				</div>

		        <p class="login-label">
		          Confirm password:
		        </p>
		        <input type="password" class="login-input" placeholder="Repeat new password">

				<button type="button" id="first-btn" name="next">Next</button>
			</form>

			<form class="login-form second">
				<p class="login-label">
		          Enter your name:
		        </p>
		        <input type="text" class="login-input" placeholder="First name">
				<input type="text" class="login-input" placeholder="Last name">
		        <p class="login-label">
		          Select your department:
		        </p>
				<input list="departments" class="login-input" placeholder="Choose your department">
				<datalist id="departments">
					<option value="prova"></option>
					<option value="prova2"></option>
				</datalist>

				<button type="button" id="second-btn" name="next">Next</button>
			</form>

			<form class="login-form third">

				<img src="res\photo.png" alt="profile">
				<p class="login-label">
		          Upload a picture (optional)
		        </p>
				<input type="file">
				<p class="login-label">
		          Create a Username:
		        </p>
				<input type="text" class="login-input" placeholder="Username">
				<button type="button" id="last-btn" name="next">Let's begin!</button>
			</form>
		</section>

		<script type="text/javascript">

			$("#first-btn").click(function(){
				if(!checkPsw(this))
					$("input").css("border-color", "red")
				else {
					$("input").css("border-color", "#0fa3b1")
					$(".first").hide("slide", {direction: "left"})
					$(".second").show("slide", {direction: "right"})
				}

			})

			$("#second-btn").click(function(){
				if(!checkForm(this, "name"))
					$("input").css("border-color", "red")
				else {
					$("input").css("border-color", "#0fa3b1")
					$(".second").hide("slide", {direction: "left"})
					$(".third").show("slide", {direction: "right"})
				}

			})

			$("#last-btn").click(function(){
				if(!checkForm(this, "username"))
					$("input").css("border-color", "red")
				else {
					$("input").css("border-color", "#0fa3b1")
				}
			})


			function checkForm(btn, str){
				var invalid = $("<p class='error'>Something's missing!</p>")
				$(btn).parent("form").children("input").each((i, el) => {
					switch (str) {
						case "name":
							$(invalid).insertBefore($(btn))
							if(el.value.length == 0) return false
							break
						case "username":
							$(invalid).insertBefore($(btn))
							if(el.value.length == 0 && i) return false
							break
					}
				})
				$(".error").remove()
				return true
			}

			function hashing(psw) {
				sha1(psw);
				var hash = sha1.create()
				hash.update(psw)
				hash.hex()
				return hash
			}

			function checkPsw(btn){
				var strength = new RegExp("^(?=.*[a-z])(?=.*[0-9])(?=.{8,})")
				var np1 = $(btn).parent("form").find("input")[0].value
				var np2 = $(btn).parent("form").find("input")[1].value
				var invalid = $("<p class='error'>Invalid password!</p>")
				if(!strength.test(np1)) {
					$(invalid).insertBefore($(btn))
					return false
				}
				else if(np2 && np2 == np1) {
					$(".error").remove()
					var user = firebase.auth().currentUser
					var newPassword = hashing(np1)

					user.updatePassword(newPassword).then(function() {
					  return true
					}).catch(function(error) {
					  console.error(error)
					})
				}
				else {
					$(".error").remove()
					invalid = $("<p class='error'>Passwords don't match!</p>")
					$(invalid).insertBefore($(btn))
					return false
				}
			}
		</script>
	</body>
</html>
